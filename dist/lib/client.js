"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Client = void 0;
const flow_async_1 = require("@aspectron/flow-async");
const gRPC = require("@grpc/grpc-js");
const protoLoader = require("@grpc/proto-loader");
class Client {
    constructor(options) {
        this.reconnect = true;
        this.verbose = false;
        this.options = Object.assign({
            protoPath: __dirname + '/../../messages.proto',
            host: 'localhost:16210'
        }, options || {});
        this.pending = {};
        this.log = Function.prototype.bind.call(console.log, console, `[KASPA-RPC-CLIENT]:`);
    }
    getServiceClient() {
        const { protoPath } = this.options;
        const packageDefinition = protoLoader.loadSync(protoPath, {
            keepCase: true,
            longs: String,
            enums: String,
            defaults: true,
            oneofs: true
        });
        const proto = gRPC.loadPackageDefinition(packageDefinition);
        this.proto = proto.protowire;
        const { P2P, RPC } = proto.protowire;
        return RPC;
    }
    connect() {
        this.reconnect = true;
        this.verbose && this.log('gRPC Client connecting to', this.options.host);
        const RPC = this.getServiceClient();
        this.client = new RPC(this.options.host, gRPC.credentials.createInsecure(), {
        // "grpc.keepalive_timeout_ms": 25000 
        });
        this.stream = this.createStream();
        this.initIntake(this.stream);
        const reconnect = () => {
            if (this.reconnect_dpc) {
                flow_async_1.clearDPC(this.reconnect_dpc);
                delete this.reconnect_dpc;
            }
            this.clearPending();
            delete this.stream;
            delete this.client;
            if (this.reconnect) {
                this.reconnect_dpc = flow_async_1.dpc(1000, () => {
                    this.connect();
                });
            }
        };
        this.stream.on('error', (error) => {
            this.verbose && this.log('stream:error', error);
            reconnect();
        });
        this.stream.on('end', () => {
            reconnect();
        });
    }
    disconnect() {
        if (this.reconnect_dpc) {
            flow_async_1.clearDPC(this.reconnect_dpc);
            delete this.reconnect_dpc;
        }
        this.reconnect = false;
        this.stream && this.stream.end();
        this.clearPending();
    }
    clearPending() {
        Object.keys(this.pending).forEach(key => {
            let list = this.pending[key];
            list.forEach(o => o.reject('closing by force'));
            this.pending[key] = [];
        });
    }
    close() {
        this.disconnect();
    }
    createStream() {
        if (!this.client)
            return null;
        const stream = this.client.MessageStream(() => {
        });
        return stream;
    }
    initIntake(stream) {
        stream.on('data', (data) => {
            if (data.payload) {
                let name = data.payload;
                let payload = data[name];
                let ident = name.replace(/^get|Response$/ig, '').toLowerCase();
                this.handleIntake({ name, payload, ident });
            }
        });
    }
    handleIntake(o) {
        if (this.intakeHandler) {
            this.intakeHandler(o);
        }
        else {
            let handlers = this.pending[o.name];
            this.verbose && console.log('intake:', o, 'handlers:', handlers);
            if (handlers && handlers.length) {
                let pending = handlers.shift();
                if (pending)
                    pending.resolve(o.payload);
            }
        }
    }
    setIntakeHandler(fn) {
        this.intakeHandler = fn;
    }
    post(name, args = {}) {
        if (!this.stream)
            return false;
        let req = {
            [name]: args
        };
        this.verbose && this.log('post:', req);
        this.stream.write(req);
        return true;
    }
    call(method, data) {
        this.verbose && this.log('call to', method);
        if (!this.client)
            return Promise.reject('not connected');
        return new Promise((resolve, reject) => {
            let stream = this.stream;
            if (!stream) {
                this.verbose && this.log('could not create stream');
                return reject('not connected');
            }
            const resp = method.replace(/Request$/, 'Response');
            if (!this.pending[resp])
                this.pending[resp] = [];
            let handlers = this.pending[resp];
            handlers.push({ method, data, resolve, reject });
            this.post(method, data);
        });
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxzREFBc0Q7QUFDdEQsc0NBQXNDO0FBQ3RDLGtEQUFrRDtBQU9sRCxNQUFhLE1BQU07SUFZbEIsWUFBWSxPQUFXO1FBUHZCLGNBQVMsR0FBVyxJQUFJLENBQUM7UUFHekIsWUFBTyxHQUFXLEtBQUssQ0FBQztRQUt2QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDNUIsU0FBUyxFQUFFLFNBQVMsR0FBRyx1QkFBdUI7WUFDOUMsSUFBSSxFQUFFLGlCQUFpQjtTQUN2QixFQUFFLE9BQU8sSUFBRSxFQUFFLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUcsQ0FBQztRQUNuQixJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDdEMsT0FBTyxDQUFDLEdBQUcsRUFDWCxPQUFPLEVBQ1AscUJBQXFCLENBQ3JCLENBQUM7SUFDSCxDQUFDO0lBRUQsZ0JBQWdCO1FBQ2YsTUFBTSxFQUFDLFNBQVMsRUFBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDakMsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtZQUN6RCxRQUFRLEVBQUUsSUFBSTtZQUNkLEtBQUssRUFBRSxNQUFNO1lBQ2IsS0FBSyxFQUFFLE1BQU07WUFDYixRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDO1FBRUgsTUFBTSxLQUFLLEdBQWdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3pGLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUM3QixNQUFNLEVBQUMsR0FBRyxFQUFFLEdBQUcsRUFB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QUFVLENBQUMsQ0FBQztZQUNuRCxJQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLElBQUksUUFBUSxHQUFlLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBQyxDQUFDLENBQUM7WUFFL0MsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUE7SUFDSCxDQUFDO0NBRUQ7QUEzS0Qsd0JBMktDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBkcGMsIGNsZWFyRFBDIH0gZnJvbSAnQGFzcGVjdHJvbi9mbG93LWFzeW5jJztcbmltcG9ydCAqIGFzIGdSUEMgZnJvbSAnQGdycGMvZ3JwYy1qcyc7XG5pbXBvcnQgKiBhcyBwcm90b0xvYWRlciBmcm9tICdAZ3JwYy9wcm90by1sb2FkZXInO1xuaW1wb3J0IHtcblx0UGVuZGluZ1JlcXMsIElEYXRhLCBJU3RyZWFtLCBRdWV1ZUl0ZW0sIE1lc3NhZ2VzUHJvdG8sXG5cdFNlcnZpY2VDbGllbnRDb25zdHJ1Y3RvciwgS2FzcGFkUGFja2FnZVxufSBmcm9tICcuLi90eXBlcy9jdXN0b20tdHlwZXMnO1xuXG5cbmV4cG9ydCBjbGFzcyBDbGllbnQge1xuXHRzdHJlYW06SVN0cmVhbTtcblx0b3B0aW9uczphbnk7XG5cdHBlbmRpbmc6UGVuZGluZ1JlcXM7XG5cdGludGFrZUhhbmRsZXI6RnVuY3Rpb258dW5kZWZpbmVkO1xuXHRyZWNvbm5lY3Q6Ym9vbGVhbiA9IHRydWU7XG5cdGNsaWVudDphbnl8dW5kZWZpbmVkO1xuXHRyZWNvbm5lY3RfZHBjOm51bWJlcnx1bmRlZmluZWQ7XG5cdHZlcmJvc2U6Ym9vbGVhbiA9IGZhbHNlO1xuXHRsb2c6RnVuY3Rpb247XG5cdHByb3RvOkthc3BhZFBhY2thZ2V8dW5kZWZpbmVkO1xuXG5cdGNvbnN0cnVjdG9yKG9wdGlvbnM6YW55KSB7XG5cdFx0dGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7XG5cdFx0XHRwcm90b1BhdGg6IF9fZGlybmFtZSArICcvLi4vLi4vbWVzc2FnZXMucHJvdG8nLFxuXHRcdFx0aG9zdDogJ2xvY2FsaG9zdDoxNjIxMCdcblx0XHR9LCBvcHRpb25zfHx7fSk7XG5cdFx0dGhpcy5wZW5kaW5nID0geyB9O1xuXHRcdHRoaXMubG9nID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQuY2FsbChcblx0XHRcdGNvbnNvbGUubG9nLFxuXHRcdFx0Y29uc29sZSxcblx0XHRcdGBbS0FTUEEtUlBDLUNMSUVOVF06YFxuXHRcdCk7XG5cdH1cblxuXHRnZXRTZXJ2aWNlQ2xpZW50KCk6U2VydmljZUNsaWVudENvbnN0cnVjdG9yIHtcblx0XHRjb25zdCB7cHJvdG9QYXRofSA9IHRoaXMub3B0aW9ucztcblx0XHRjb25zdCBwYWNrYWdlRGVmaW5pdGlvbiA9IHByb3RvTG9hZGVyLmxvYWRTeW5jKHByb3RvUGF0aCwge1xuXHRcdFx0a2VlcENhc2U6IHRydWUsXG5cdFx0XHRsb25nczogU3RyaW5nLFxuXHRcdFx0ZW51bXM6IFN0cmluZyxcblx0XHRcdGRlZmF1bHRzOiB0cnVlLFxuXHRcdFx0b25lb2ZzOiB0cnVlXG5cdFx0fSk7XG5cblx0XHRjb25zdCBwcm90bzpNZXNzYWdlc1Byb3RvID0gPE1lc3NhZ2VzUHJvdG8+Z1JQQy5sb2FkUGFja2FnZURlZmluaXRpb24ocGFja2FnZURlZmluaXRpb24pO1xuXHRcdHRoaXMucHJvdG8gPSBwcm90by5wcm90b3dpcmU7XG5cdFx0Y29uc3Qge1AyUCwgUlBDfSA9IHByb3RvLnByb3Rvd2lyZTtcblx0XHRyZXR1cm4gUlBDO1xuXHR9XG5cblx0Y29ubmVjdCgpIHtcblx0XHR0aGlzLnJlY29ubmVjdCA9IHRydWU7XG5cdFx0dGhpcy52ZXJib3NlICYmIHRoaXMubG9nKCdnUlBDIENsaWVudCBjb25uZWN0aW5nIHRvJywgdGhpcy5vcHRpb25zLmhvc3QpO1xuXHRcdGNvbnN0IFJQQyA9IHRoaXMuZ2V0U2VydmljZUNsaWVudCgpO1xuXHRcdHRoaXMuY2xpZW50ID0gbmV3IFJQQyh0aGlzLm9wdGlvbnMuaG9zdCwgZ1JQQy5jcmVkZW50aWFscy5jcmVhdGVJbnNlY3VyZSgpLFxuXHRcdFx0eyBcblx0XHRcdFx0Ly8gXCJncnBjLmtlZXBhbGl2ZV90aW1lb3V0X21zXCI6IDI1MDAwIFxuXHRcdFx0fVxuXHRcdCk7XG5cblx0XHR0aGlzLnN0cmVhbSA9IHRoaXMuY3JlYXRlU3RyZWFtKCk7XG5cdFx0dGhpcy5pbml0SW50YWtlKHRoaXMuc3RyZWFtKTtcblx0XHRjb25zdCByZWNvbm5lY3QgPSAoKSA9PiB7XG5cdFx0XHRpZih0aGlzLnJlY29ubmVjdF9kcGMpIHtcblx0XHRcdFx0Y2xlYXJEUEModGhpcy5yZWNvbm5lY3RfZHBjKTtcblx0XHRcdFx0ZGVsZXRlIHRoaXMucmVjb25uZWN0X2RwYztcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5jbGVhclBlbmRpbmcoKTtcblx0XHRcdGRlbGV0ZSB0aGlzLnN0cmVhbTtcblx0XHRcdGRlbGV0ZSB0aGlzLmNsaWVudDtcblx0XHRcdGlmKHRoaXMucmVjb25uZWN0KSB7XG5cdFx0XHRcdHRoaXMucmVjb25uZWN0X2RwYyA9IGRwYygxMDAwLCAoKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5jb25uZWN0KCk7XG5cdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0fVxuXHRcdHRoaXMuc3RyZWFtLm9uKCdlcnJvcicsIChlcnJvcjphbnkpID0+IHtcblx0XHRcdHRoaXMudmVyYm9zZSAmJiB0aGlzLmxvZygnc3RyZWFtOmVycm9yJywgZXJyb3IpO1xuXHRcdFx0cmVjb25uZWN0KCk7XG5cdFx0fSlcblx0XHR0aGlzLnN0cmVhbS5vbignZW5kJywgKCkgPT4ge1xuXHRcdFx0cmVjb25uZWN0KCk7XG5cdFx0fSlcblx0fVxuXG5cdGRpc2Nvbm5lY3QoKSB7XG5cdFx0aWYodGhpcy5yZWNvbm5lY3RfZHBjKSB7XG5cdFx0XHRjbGVhckRQQyh0aGlzLnJlY29ubmVjdF9kcGMpO1xuXHRcdFx0ZGVsZXRlIHRoaXMucmVjb25uZWN0X2RwYztcblx0XHR9XG5cdFx0dGhpcy5yZWNvbm5lY3QgPSBmYWxzZTtcblx0XHR0aGlzLnN0cmVhbSAmJiB0aGlzLnN0cmVhbS5lbmQoKTtcblx0XHR0aGlzLmNsZWFyUGVuZGluZygpO1xuXHR9XG5cblx0Y2xlYXJQZW5kaW5nKCkge1xuXHRcdE9iamVjdC5rZXlzKHRoaXMucGVuZGluZykuZm9yRWFjaChrZXkgPT4ge1xuXHRcdFx0bGV0IGxpc3QgPSB0aGlzLnBlbmRpbmdba2V5XTtcblx0XHRcdGxpc3QuZm9yRWFjaChvPT5vLnJlamVjdCgnY2xvc2luZyBieSBmb3JjZScpKTtcblx0XHRcdHRoaXMucGVuZGluZ1trZXldID0gW107XG5cdFx0fSk7XG5cdH1cblxuXHRjbG9zZSgpIHtcblx0XHR0aGlzLmRpc2Nvbm5lY3QoKVxuXHR9XG5cblx0Y3JlYXRlU3RyZWFtKCkge1xuXHRcdGlmKCF0aGlzLmNsaWVudClcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdGNvbnN0IHN0cmVhbSA9IHRoaXMuY2xpZW50Lk1lc3NhZ2VTdHJlYW0oKCk9Pntcblx0XHR9KTtcblx0XHRyZXR1cm4gc3RyZWFtO1xuXHR9XG5cblx0aW5pdEludGFrZShzdHJlYW06SVN0cmVhbSkge1xuXHRcdHN0cmVhbS5vbignZGF0YScsIChkYXRhOmFueSkgPT4ge1xuXHRcdFx0aWYoZGF0YS5wYXlsb2FkKSB7XG5cdFx0XHRcdGxldCBuYW1lID0gZGF0YS5wYXlsb2FkO1xuXHRcdFx0XHRsZXQgcGF5bG9hZCA9IGRhdGFbbmFtZV07XG5cdFx0XHRcdGxldCBpZGVudCA9IG5hbWUucmVwbGFjZSgvXmdldHxSZXNwb25zZSQvaWcsJycpLnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRcdHRoaXMuaGFuZGxlSW50YWtlKHtuYW1lLCBwYXlsb2FkLCBpZGVudCB9KTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGhhbmRsZUludGFrZShvOklEYXRhKSB7XG5cdFx0aWYodGhpcy5pbnRha2VIYW5kbGVyKSB7XG5cdFx0XHR0aGlzLmludGFrZUhhbmRsZXIobyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCBoYW5kbGVycyA9IHRoaXMucGVuZGluZ1tvLm5hbWVdO1xuXHRcdFx0dGhpcy52ZXJib3NlICYmIGNvbnNvbGUubG9nKCdpbnRha2U6JyxvLCdoYW5kbGVyczonLGhhbmRsZXJzKTtcblx0XHRcdGlmKGhhbmRsZXJzICYmIGhhbmRsZXJzLmxlbmd0aCl7XG5cdFx0XHRcdGxldCBwZW5kaW5nOlF1ZXVlSXRlbXx1bmRlZmluZWQgPSBoYW5kbGVycy5zaGlmdCgpO1xuXHRcdFx0XHRpZihwZW5kaW5nKVxuXHRcdFx0XHRcdHBlbmRpbmcucmVzb2x2ZShvLnBheWxvYWQpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHNldEludGFrZUhhbmRsZXIoZm46RnVuY3Rpb24pIHtcblx0XHR0aGlzLmludGFrZUhhbmRsZXIgPSBmbjtcblx0fVxuXG5cdHBvc3QobmFtZTpzdHJpbmcsIGFyZ3M6YW55PXsgfSkge1xuXHRcdGlmKCF0aGlzLnN0cmVhbSlcblx0XHRcdHJldHVybiBmYWxzZTtcblxuXHRcdGxldCByZXEgPSB7XG5cdFx0XHRbbmFtZV06YXJnc1xuXHRcdH1cblx0XHR0aGlzLnZlcmJvc2UgJiYgdGhpcy5sb2coJ3Bvc3Q6JyxyZXEpO1xuXHRcdHRoaXMuc3RyZWFtLndyaXRlKHJlcSk7XG5cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdGNhbGwobWV0aG9kOnN0cmluZywgZGF0YTphbnkpIHtcblx0XHR0aGlzLnZlcmJvc2UgJiYgdGhpcy5sb2coJ2NhbGwgdG8nLCBtZXRob2QpO1xuXHRcdGlmKCF0aGlzLmNsaWVudClcblx0XHRcdHJldHVybiBQcm9taXNlLnJlamVjdCgnbm90IGNvbm5lY3RlZCcpO1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdGxldCBzdHJlYW0gPSB0aGlzLnN0cmVhbTtcblx0XHRcdGlmKCFzdHJlYW0pIHtcblx0XHRcdFx0dGhpcy52ZXJib3NlICYmICB0aGlzLmxvZygnY291bGQgbm90IGNyZWF0ZSBzdHJlYW0nKTtcblx0XHRcdFx0cmV0dXJuIHJlamVjdCgnbm90IGNvbm5lY3RlZCcpO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCByZXNwID0gbWV0aG9kLnJlcGxhY2UoL1JlcXVlc3QkLywnUmVzcG9uc2UnKTtcblx0XHRcdGlmKCF0aGlzLnBlbmRpbmdbcmVzcF0pXG5cdFx0XHRcdHRoaXMucGVuZGluZ1tyZXNwXSA9IFtdO1xuXHRcdFx0bGV0IGhhbmRsZXJzOlF1ZXVlSXRlbVtdID0gdGhpcy5wZW5kaW5nW3Jlc3BdO1xuXHRcdFx0aGFuZGxlcnMucHVzaCh7bWV0aG9kLCBkYXRhLCByZXNvbHZlLCByZWplY3R9KTtcblxuXHRcdFx0dGhpcy5wb3N0KG1ldGhvZCwgZGF0YSk7XG5cdFx0fSlcblx0fVxuXG59XG4iXX0=