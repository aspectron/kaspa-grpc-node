"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Client = void 0;
const flow_async_1 = require("@aspectron/flow-async");
const gRPC = require("@grpc/grpc-js");
const protoLoader = require("@grpc/proto-loader");
class Client {
    constructor(options) {
        this.reconnect = true;
        this.verbose = false;
        this.options = Object.assign({
            protoPath: __dirname + '/../messages.proto',
            host: 'localhost:16210'
        }, options || {});
        this.pending = {};
    }
    getServiceClient() {
        const { protoPath } = this.options;
        const packageDefinition = protoLoader.loadSync(protoPath, {
            keepCase: true,
            longs: String,
            enums: String,
            defaults: true,
            oneofs: true
        });
        const proto = gRPC.loadPackageDefinition(packageDefinition);
        const { P2P, RPC } = proto.protowire;
        return RPC;
    }
    connect() {
        this.reconnect = true;
        console.log('gRPC connecting to', this.options.host);
        const RPC = this.getServiceClient();
        this.client = new RPC(this.options.host, gRPC.credentials.createInsecure(), {
        // "grpc.keepalive_timeout_ms": 25000 
        });
        this.stream = this.createStream();
        this.initIntake(this.stream);
        const reconnect = () => {
            if (this.reconnect_dpc) {
                flow_async_1.clearDPC(this.reconnect_dpc);
                delete this.reconnect_dpc;
            }
            this.clearPending();
            delete this.stream;
            delete this.client;
            if (this.reconnect) {
                this.reconnect_dpc = flow_async_1.dpc(1000, () => {
                    this.connect();
                });
            }
        };
        this.stream.on('error', (error) => {
            console.error('gRPC', error);
            reconnect();
        });
        this.stream.on('end', () => {
            reconnect();
        });
    }
    disconnect() {
        if (this.reconnect_dpc) {
            flow_async_1.clearDPC(this.reconnect_dpc);
            delete this.reconnect_dpc;
        }
        this.reconnect = false;
        this.stream && this.stream.end();
        this.clearPending();
    }
    clearPending() {
        Object.keys(this.pending).forEach(key => {
            let list = this.pending[key];
            list.forEach(o => o.reject('closing by force'));
            this.pending[key] = [];
        });
    }
    close() {
        this.disconnect();
    }
    createStream() {
        if (!this.client)
            return null;
        const stream = this.client.MessageStream(() => {
        });
        return stream;
    }
    initIntake(stream) {
        stream.on('data', (data) => {
            if (data.payload) {
                let name = data.payload;
                let payload = data[name];
                let ident = name.replace(/^get|Response$/ig, '').toLowerCase();
                this.handleIntake({ name, payload, ident });
            }
        });
    }
    handleIntake(o) {
        if (this.intakeHandler) {
            this.intakeHandler(o);
        }
        else {
            let handlers = this.pending[o.name];
            this.verbose && console.log('intake:', o, 'handlers:', handlers);
            if (handlers && handlers.length) {
                let pending = handlers.shift();
                if (pending)
                    pending.resolve(o.payload);
            }
        }
    }
    setIntakeHandler(fn) {
        this.intakeHandler = fn;
    }
    post(name, args = {}) {
        if (!this.stream)
            return false;
        let req = {
            [name]: args
        };
        this.verbose && console.log('post:', req);
        this.stream.write(req);
        return true;
    }
    call(method, data) {
        this.verbose && console.log('call to', method);
        if (!this.client)
            return Promise.reject('not connected');
        return new Promise((resolve, reject) => {
            let stream = this.stream;
            if (!stream) {
                console.log('could not create stream');
                return reject('not connected');
            }
            const resp = method.replace(/Request$/, 'Response');
            if (!this.pending[resp])
                this.pending[resp] = [];
            let handlers = this.pending[resp];
            handlers.push({ method, data, resolve, reject });
            this.post(method, data);
        });
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxzREFBc0Q7QUFDdEQsc0NBQXNDO0FBQ3RDLGtEQUFrRDtBQU9sRCxNQUFhLE1BQU07SUFVbEIsWUFBWSxPQUFXO1FBTHZCLGNBQVMsR0FBVyxJQUFJLENBQUM7UUFHekIsWUFBTyxHQUFXLEtBQUssQ0FBQztRQUd2QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDNUIsU0FBUyxFQUFFLFNBQVMsR0FBRyxvQkFBb0I7WUFDM0MsSUFBSSxFQUFFLGlCQUFpQjtTQUN2QixFQUFFLE9BQU8sSUFBRSxFQUFFLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUcsQ0FBQztJQUNwQixDQUFDO0lBRUQsZ0JBQWdCO1FBQ2YsTUFBTSxFQUFDLFNBQVMsRUFBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDakMsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtZQUN6RCxRQUFRLEVBQUUsSUFBSTtZQUNkLEtBQUssRUFBRSxNQUFNO1lBQ2IsS0FBSyxFQUFFLE1BQU07WUFDYixRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDO1FBRUgsTUFBTSxLQUFLLEdBQWdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3pGLE1BQU0sRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNuQyxPQUFPLEdBQUcsQ0FBQztJQUNaLENBQUM7SUFFRCxPQUFPO1FBQ04sSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFD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QUFPLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztZQUUvQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQTtJQUNILENBQUM7Q0FFRDtBQW5LRCx3QkFtS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGRwYywgY2xlYXJEUEMgfSBmcm9tICdAYXNwZWN0cm9uL2Zsb3ctYXN5bmMnO1xuaW1wb3J0ICogYXMgZ1JQQyBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCAqIGFzIHByb3RvTG9hZGVyIGZyb20gJ0BncnBjL3Byb3RvLWxvYWRlcic7XG5pbXBvcnQge1xuXHRQZW5kaW5nUmVxcywgSURhdGEsIElTdHJlYW0sIFF1ZXVlSXRlbSwgTWVzc2FnZXNQcm90byxcblx0U2VydmljZUNsaWVudENvbnN0cnVjdG9yXG59IGZyb20gJy4uL3R5cGVzL2N1c3RvbS10eXBlcyc7XG5cblxuZXhwb3J0IGNsYXNzIENsaWVudCB7XG5cdHN0cmVhbTpJU3RyZWFtO1xuXHRvcHRpb25zOmFueTtcblx0cGVuZGluZzpQZW5kaW5nUmVxcztcblx0aW50YWtlSGFuZGxlcjpGdW5jdGlvbnx1bmRlZmluZWQ7XG5cdHJlY29ubmVjdDpib29sZWFuID0gdHJ1ZTtcblx0Y2xpZW50OmFueXx1bmRlZmluZWQ7XG5cdHJlY29ubmVjdF9kcGM6bnVtYmVyfHVuZGVmaW5lZDtcblx0dmVyYm9zZTpib29sZWFuID0gZmFsc2U7XG5cblx0Y29uc3RydWN0b3Iob3B0aW9uczphbnkpIHtcblx0XHR0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHtcblx0XHRcdHByb3RvUGF0aDogX19kaXJuYW1lICsgJy8uLi9tZXNzYWdlcy5wcm90bycsXG5cdFx0XHRob3N0OiAnbG9jYWxob3N0OjE2MjEwJ1xuXHRcdH0sIG9wdGlvbnN8fHt9KTtcblx0XHR0aGlzLnBlbmRpbmcgPSB7IH07XG5cdH1cblxuXHRnZXRTZXJ2aWNlQ2xpZW50KCk6U2VydmljZUNsaWVudENvbnN0cnVjdG9yIHtcblx0XHRjb25zdCB7cHJvdG9QYXRofSA9IHRoaXMub3B0aW9ucztcblx0XHRjb25zdCBwYWNrYWdlRGVmaW5pdGlvbiA9IHByb3RvTG9hZGVyLmxvYWRTeW5jKHByb3RvUGF0aCwge1xuXHRcdFx0a2VlcENhc2U6IHRydWUsXG5cdFx0XHRsb25nczogU3RyaW5nLFxuXHRcdFx0ZW51bXM6IFN0cmluZyxcblx0XHRcdGRlZmF1bHRzOiB0cnVlLFxuXHRcdFx0b25lb2ZzOiB0cnVlXG5cdFx0fSk7XG5cblx0XHRjb25zdCBwcm90bzpNZXNzYWdlc1Byb3RvID0gPE1lc3NhZ2VzUHJvdG8+Z1JQQy5sb2FkUGFja2FnZURlZmluaXRpb24ocGFja2FnZURlZmluaXRpb24pO1xuXHRcdGNvbnN0IHtQMlAsIFJQQ30gPSBwcm90by5wcm90b3dpcmU7XG5cdFx0cmV0dXJuIFJQQztcblx0fVxuXG5cdGNvbm5lY3QoKSB7XG5cdFx0dGhpcy5yZWNvbm5lY3QgPSB0cnVlO1xuXHRcdGNvbnNvbGUubG9nKCdnUlBDIGNvbm5lY3RpbmcgdG8nLCB0aGlzLm9wdGlvbnMuaG9zdCk7XG5cdFx0Y29uc3QgUlBDID0gdGhpcy5nZXRTZXJ2aWNlQ2xpZW50KCk7XG5cdFx0dGhpcy5jbGllbnQgPSBuZXcgUlBDKHRoaXMub3B0aW9ucy5ob3N0LCBnUlBDLmNyZWRlbnRpYWxzLmNyZWF0ZUluc2VjdXJlKCksXG5cdFx0XHR7IFxuXHRcdFx0XHQvLyBcImdycGMua2VlcGFsaXZlX3RpbWVvdXRfbXNcIjogMjUwMDAgXG5cdFx0XHR9XG5cdFx0KTtcblxuXHRcdHRoaXMuc3RyZWFtID0gdGhpcy5jcmVhdGVTdHJlYW0oKTtcblx0XHR0aGlzLmluaXRJbnRha2UodGhpcy5zdHJlYW0pO1xuXHRcdGNvbnN0IHJlY29ubmVjdCA9ICgpID0+IHtcblx0XHRcdGlmKHRoaXMucmVjb25uZWN0X2RwYykge1xuXHRcdFx0XHRjbGVhckRQQyh0aGlzLnJlY29ubmVjdF9kcGMpO1xuXHRcdFx0XHRkZWxldGUgdGhpcy5yZWNvbm5lY3RfZHBjO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmNsZWFyUGVuZGluZygpO1xuXHRcdFx0ZGVsZXRlIHRoaXMuc3RyZWFtO1xuXHRcdFx0ZGVsZXRlIHRoaXMuY2xpZW50O1xuXHRcdFx0aWYodGhpcy5yZWNvbm5lY3QpIHtcblx0XHRcdFx0dGhpcy5yZWNvbm5lY3RfZHBjID0gZHBjKDEwMDAsICgpID0+IHtcblx0XHRcdFx0XHR0aGlzLmNvbm5lY3QoKTtcblx0XHRcdFx0fSlcblx0XHRcdH1cblx0XHR9XG5cdFx0dGhpcy5zdHJlYW0ub24oJ2Vycm9yJywgKGVycm9yOmFueSkgPT4ge1xuXHRcdFx0Y29uc29sZS5lcnJvcignZ1JQQycsZXJyb3IpO1xuXHRcdFx0cmVjb25uZWN0KCk7XG5cdFx0fSlcblx0XHR0aGlzLnN0cmVhbS5vbignZW5kJywgKCkgPT4ge1xuXHRcdFx0cmVjb25uZWN0KCk7XG5cdFx0fSlcblx0fVxuXG5cdGRpc2Nvbm5lY3QoKSB7XG5cdFx0aWYodGhpcy5yZWNvbm5lY3RfZHBjKSB7XG5cdFx0XHRjbGVhckRQQyh0aGlzLnJlY29ubmVjdF9kcGMpO1xuXHRcdFx0ZGVsZXRlIHRoaXMucmVjb25uZWN0X2RwYztcblx0XHR9XG5cdFx0dGhpcy5yZWNvbm5lY3QgPSBmYWxzZTtcblx0XHR0aGlzLnN0cmVhbSAmJiB0aGlzLnN0cmVhbS5lbmQoKTtcblx0XHR0aGlzLmNsZWFyUGVuZGluZygpO1xuXHR9XG5cblx0Y2xlYXJQZW5kaW5nKCkge1xuXHRcdE9iamVjdC5rZXlzKHRoaXMucGVuZGluZykuZm9yRWFjaChrZXkgPT4ge1xuXHRcdFx0bGV0IGxpc3QgPSB0aGlzLnBlbmRpbmdba2V5XTtcblx0XHRcdGxpc3QuZm9yRWFjaChvPT5vLnJlamVjdCgnY2xvc2luZyBieSBmb3JjZScpKTtcblx0XHRcdHRoaXMucGVuZGluZ1trZXldID0gW107XG5cdFx0fSk7XG5cdH1cblxuXHRjbG9zZSgpIHtcblx0XHR0aGlzLmRpc2Nvbm5lY3QoKVxuXHR9XG5cblx0Y3JlYXRlU3RyZWFtKCkge1xuXHRcdGlmKCF0aGlzLmNsaWVudClcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdGNvbnN0IHN0cmVhbSA9IHRoaXMuY2xpZW50Lk1lc3NhZ2VTdHJlYW0oKCk9Pntcblx0XHR9KTtcblx0XHRyZXR1cm4gc3RyZWFtO1xuXHR9XG5cblx0aW5pdEludGFrZShzdHJlYW06SVN0cmVhbSkge1xuXHRcdHN0cmVhbS5vbignZGF0YScsIChkYXRhOmFueSkgPT4ge1xuXHRcdFx0aWYoZGF0YS5wYXlsb2FkKSB7XG5cdFx0XHRcdGxldCBuYW1lID0gZGF0YS5wYXlsb2FkO1xuXHRcdFx0XHRsZXQgcGF5bG9hZCA9IGRhdGFbbmFtZV07XG5cdFx0XHRcdGxldCBpZGVudCA9IG5hbWUucmVwbGFjZSgvXmdldHxSZXNwb25zZSQvaWcsJycpLnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRcdHRoaXMuaGFuZGxlSW50YWtlKHtuYW1lLCBwYXlsb2FkLCBpZGVudCB9KTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGhhbmRsZUludGFrZShvOklEYXRhKSB7XG5cdFx0aWYodGhpcy5pbnRha2VIYW5kbGVyKSB7XG5cdFx0XHR0aGlzLmludGFrZUhhbmRsZXIobyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCBoYW5kbGVycyA9IHRoaXMucGVuZGluZ1tvLm5hbWVdO1xuXHRcdFx0dGhpcy52ZXJib3NlICYmIGNvbnNvbGUubG9nKCdpbnRha2U6JyxvLCdoYW5kbGVyczonLGhhbmRsZXJzKTtcblx0XHRcdGlmKGhhbmRsZXJzICYmIGhhbmRsZXJzLmxlbmd0aCl7XG5cdFx0XHRcdGxldCBwZW5kaW5nOlF1ZXVlSXRlbXx1bmRlZmluZWQgPSBoYW5kbGVycy5zaGlmdCgpO1xuXHRcdFx0XHRpZihwZW5kaW5nKVxuXHRcdFx0XHRcdHBlbmRpbmcucmVzb2x2ZShvLnBheWxvYWQpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHNldEludGFrZUhhbmRsZXIoZm46RnVuY3Rpb24pIHtcblx0XHR0aGlzLmludGFrZUhhbmRsZXIgPSBmbjtcblx0fVxuXG5cdHBvc3QobmFtZTpzdHJpbmcsIGFyZ3M6YW55PXsgfSkge1xuXHRcdGlmKCF0aGlzLnN0cmVhbSlcblx0XHRcdHJldHVybiBmYWxzZTtcblxuXHRcdGxldCByZXEgPSB7XG5cdFx0XHRbbmFtZV06YXJnc1xuXHRcdH1cblx0XHR0aGlzLnZlcmJvc2UgJiYgY29uc29sZS5sb2coJ3Bvc3Q6JyxyZXEpO1xuXHRcdHRoaXMuc3RyZWFtLndyaXRlKHJlcSk7XG5cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdGNhbGwobWV0aG9kOnN0cmluZywgZGF0YTphbnkpIHtcblx0XHR0aGlzLnZlcmJvc2UgJiYgY29uc29sZS5sb2coJ2NhbGwgdG8nLCBtZXRob2QpO1xuXHRcdGlmKCF0aGlzLmNsaWVudClcblx0XHRcdHJldHVybiBQcm9taXNlLnJlamVjdCgnbm90IGNvbm5lY3RlZCcpO1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdGxldCBzdHJlYW0gPSB0aGlzLnN0cmVhbTtcblx0XHRcdGlmKCFzdHJlYW0pIHtcblx0XHRcdFx0Y29uc29sZS5sb2coJ2NvdWxkIG5vdCBjcmVhdGUgc3RyZWFtJyk7XG5cdFx0XHRcdHJldHVybiByZWplY3QoJ25vdCBjb25uZWN0ZWQnKTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVzcCA9IG1ldGhvZC5yZXBsYWNlKC9SZXF1ZXN0JC8sJ1Jlc3BvbnNlJyk7XG5cdFx0XHRpZighdGhpcy5wZW5kaW5nW3Jlc3BdKVxuXHRcdFx0XHR0aGlzLnBlbmRpbmdbcmVzcF0gPSBbXTtcblx0XHRcdGxldCBoYW5kbGVyczpRdWV1ZUl0ZW1bXSA9IHRoaXMucGVuZGluZ1tyZXNwXTtcblx0XHRcdGhhbmRsZXJzLnB1c2goe21ldGhvZCwgZGF0YSwgcmVzb2x2ZSwgcmVqZWN0fSk7XG5cblx0XHRcdHRoaXMucG9zdChtZXRob2QsIGRhdGEpO1xuXHRcdH0pXG5cdH1cblxufVxuIl19