"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Client = void 0;
const flow_async_1 = require("@aspectron/flow-async");
const gRPC = require("@grpc/grpc-js");
const protoLoader = require("@grpc/proto-loader");
class Client {
    constructor(options) {
        this.reconnect = true;
        this.verbose = false;
        this.options = Object.assign({
            protoPath: __dirname + '/../../messages.proto',
            host: 'localhost:16210'
        }, options || {});
        this.pending = {};
        this.log = Function.prototype.bind.call(console.log, console, `[KASPA-RPC-CLIENT]:`);
    }
    getServiceClient() {
        const { protoPath } = this.options;
        const packageDefinition = protoLoader.loadSync(protoPath, {
            keepCase: true,
            longs: String,
            enums: String,
            defaults: true,
            oneofs: true
        });
        const proto = gRPC.loadPackageDefinition(packageDefinition);
        this.proto = proto.protowire;
        const { P2P, RPC } = proto.protowire;
        return RPC;
    }
    connect() {
        this.reconnect = true;
        this.verbose && this.log('gRPC Client connecting to', this.options.host);
        const RPC = this.getServiceClient();
        this.client = new RPC(this.options.host, gRPC.credentials.createInsecure(), {
            // "grpc.keepalive_timeout_ms": 25000 
            "grpc.max_receive_message_length": -1
        });
        this.stream = this.createStream();
        this.initIntake(this.stream);
        const reconnect = () => {
            if (this.reconnect_dpc) {
                flow_async_1.clearDPC(this.reconnect_dpc);
                delete this.reconnect_dpc;
            }
            this.clearPending();
            delete this.stream;
            delete this.client;
            if (this.reconnect) {
                this.reconnect_dpc = flow_async_1.dpc(1000, () => {
                    this.connect();
                });
            }
        };
        this.stream.on('error', (error) => {
            this.verbose && this.log('stream:error', error);
            reconnect();
        });
        this.stream.on('end', () => {
            reconnect();
        });
    }
    disconnect() {
        if (this.reconnect_dpc) {
            flow_async_1.clearDPC(this.reconnect_dpc);
            delete this.reconnect_dpc;
        }
        this.reconnect = false;
        this.stream && this.stream.end();
        this.clearPending();
    }
    clearPending() {
        Object.keys(this.pending).forEach(key => {
            let list = this.pending[key];
            list.forEach(o => o.reject('closing by force'));
            this.pending[key] = [];
        });
    }
    close() {
        this.disconnect();
    }
    createStream() {
        if (!this.client)
            return null;
        const stream = this.client.MessageStream(() => {
        });
        return stream;
    }
    initIntake(stream) {
        stream.on('data', (data) => {
            if (data.payload) {
                let name = data.payload;
                let payload = data[name];
                let ident = name.replace(/^get|Response$/ig, '').toLowerCase();
                this.handleIntake({ name, payload, ident });
            }
        });
    }
    handleIntake(o) {
        if (this.intakeHandler) {
            this.intakeHandler(o);
        }
        else {
            let handlers = this.pending[o.name];
            this.verbose && console.log('intake:', o, 'handlers:', handlers);
            if (handlers && handlers.length) {
                let pending = handlers.shift();
                if (pending)
                    pending.resolve(o.payload);
            }
        }
    }
    setIntakeHandler(fn) {
        this.intakeHandler = fn;
    }
    post(name, args = {}) {
        if (!this.stream)
            return false;
        let req = {
            [name]: args
        };
        this.verbose && this.log('post:', req);
        this.stream.write(req);
        return true;
    }
    call(method, data) {
        this.verbose && this.log('call to', method);
        if (!this.client)
            return Promise.reject('not connected');
        return new Promise((resolve, reject) => {
            let stream = this.stream;
            if (!stream) {
                this.verbose && this.log('could not create stream');
                return reject('not connected');
            }
            const resp = method.replace(/Request$/, 'Response');
            if (!this.pending[resp])
                this.pending[resp] = [];
            let handlers = this.pending[resp];
            handlers.push({ method, data, resolve, reject });
            this.post(method, data);
        });
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxzREFBc0Q7QUFDdEQsc0NBQXNDO0FBQ3RDLGtEQUFrRDtBQU9sRCxNQUFhLE1BQU07SUFZbEIsWUFBWSxPQUFXO1FBUHZCLGNBQVMsR0FBVyxJQUFJLENBQUM7UUFHekIsWUFBTyxHQUFXLEtBQUssQ0FBQztRQUt2QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDNUIsU0FBUyxFQUFFLFNBQVMsR0FBRyx1QkFBdUI7WUFDOUMsSUFBSSxFQUFFLGlCQUFpQjtTQUN2QixFQUFFLE9BQU8sSUFBRSxFQUFFLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUcsQ0FBQztRQUNuQixJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDdEMsT0FBTyxDQUFDLEdBQUcsRUFDWCxPQUFPLEVBQ1AscUJBQXFCLENBQ3JCLENBQUM7SUFDSCxDQUFDO0lBRUQsZ0JBQWdCO1FBQ2YsTUFBTSxFQUFDLFNBQVMsRUFBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDakMsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtZQUN6RCxRQUFRLEVBQUUsSUFBSTtZQUNkLEtBQUssRUFBRSxNQUFNO1lBQ2IsS0FBSyxFQUFFLE1BQU07WUFDYixRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDO1FBRUgsTUFBTSxLQUFLLEdBQWdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3pGLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUM3QixNQUFNLEVBQUMsR0FBRyxFQUFFLEdBQUcsRUFB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TSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkQsSUFBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO2dCQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN6QixJQUFJLFFBQVEsR0FBZSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDO1lBRS9DLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFBO0lBQ0gsQ0FBQztDQUVEO0FBNUtELHdCQTRLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgZHBjLCBjbGVhckRQQyB9IGZyb20gJ0Bhc3BlY3Ryb24vZmxvdy1hc3luYyc7XG5pbXBvcnQgKiBhcyBnUlBDIGZyb20gJ0BncnBjL2dycGMtanMnO1xuaW1wb3J0ICogYXMgcHJvdG9Mb2FkZXIgZnJvbSAnQGdycGMvcHJvdG8tbG9hZGVyJztcbmltcG9ydCB7XG5cdFBlbmRpbmdSZXFzLCBJRGF0YSwgSVN0cmVhbSwgUXVldWVJdGVtLCBNZXNzYWdlc1Byb3RvLFxuXHRTZXJ2aWNlQ2xpZW50Q29uc3RydWN0b3IsIEthc3BhZFBhY2thZ2Vcbn0gZnJvbSAnLi4vdHlwZXMvY3VzdG9tLXR5cGVzJztcblxuXG5leHBvcnQgY2xhc3MgQ2xpZW50IHtcblx0c3RyZWFtOklTdHJlYW07XG5cdG9wdGlvbnM6YW55O1xuXHRwZW5kaW5nOlBlbmRpbmdSZXFzO1xuXHRpbnRha2VIYW5kbGVyOkZ1bmN0aW9ufHVuZGVmaW5lZDtcblx0cmVjb25uZWN0OmJvb2xlYW4gPSB0cnVlO1xuXHRjbGllbnQ6YW55fHVuZGVmaW5lZDtcblx0cmVjb25uZWN0X2RwYzpudW1iZXJ8dW5kZWZpbmVkO1xuXHR2ZXJib3NlOmJvb2xlYW4gPSBmYWxzZTtcblx0bG9nOkZ1bmN0aW9uO1xuXHRwcm90bzpLYXNwYWRQYWNrYWdlfHVuZGVmaW5lZDtcblxuXHRjb25zdHJ1Y3RvcihvcHRpb25zOmFueSkge1xuXHRcdHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuXHRcdFx0cHJvdG9QYXRoOiBfX2Rpcm5hbWUgKyAnLy4uLy4uL21lc3NhZ2VzLnByb3RvJyxcblx0XHRcdGhvc3Q6ICdsb2NhbGhvc3Q6MTYyMTAnXG5cdFx0fSwgb3B0aW9uc3x8e30pO1xuXHRcdHRoaXMucGVuZGluZyA9IHsgfTtcblx0XHR0aGlzLmxvZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoXG5cdFx0XHRjb25zb2xlLmxvZyxcblx0XHRcdGNvbnNvbGUsXG5cdFx0XHRgW0tBU1BBLVJQQy1DTElFTlRdOmBcblx0XHQpO1xuXHR9XG5cblx0Z2V0U2VydmljZUNsaWVudCgpOlNlcnZpY2VDbGllbnRDb25zdHJ1Y3RvciB7XG5cdFx0Y29uc3Qge3Byb3RvUGF0aH0gPSB0aGlzLm9wdGlvbnM7XG5cdFx0Y29uc3QgcGFja2FnZURlZmluaXRpb24gPSBwcm90b0xvYWRlci5sb2FkU3luYyhwcm90b1BhdGgsIHtcblx0XHRcdGtlZXBDYXNlOiB0cnVlLFxuXHRcdFx0bG9uZ3M6IFN0cmluZyxcblx0XHRcdGVudW1zOiBTdHJpbmcsXG5cdFx0XHRkZWZhdWx0czogdHJ1ZSxcblx0XHRcdG9uZW9mczogdHJ1ZVxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgcHJvdG86TWVzc2FnZXNQcm90byA9IDxNZXNzYWdlc1Byb3RvPmdSUEMubG9hZFBhY2thZ2VEZWZpbml0aW9uKHBhY2thZ2VEZWZpbml0aW9uKTtcblx0XHR0aGlzLnByb3RvID0gcHJvdG8ucHJvdG93aXJlO1xuXHRcdGNvbnN0IHtQMlAsIFJQQ30gPSBwcm90by5wcm90b3dpcmU7XG5cdFx0cmV0dXJuIFJQQztcblx0fVxuXG5cdGNvbm5lY3QoKSB7XG5cdFx0dGhpcy5yZWNvbm5lY3QgPSB0cnVlO1xuXHRcdHRoaXMudmVyYm9zZSAmJiB0aGlzLmxvZygnZ1JQQyBDbGllbnQgY29ubmVjdGluZyB0bycsIHRoaXMub3B0aW9ucy5ob3N0KTtcblx0XHRjb25zdCBSUEMgPSB0aGlzLmdldFNlcnZpY2VDbGllbnQoKTtcblx0XHR0aGlzLmNsaWVudCA9IG5ldyBSUEModGhpcy5vcHRpb25zLmhvc3QsIGdSUEMuY3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKSxcblx0XHRcdHsgXG5cdFx0XHRcdC8vIFwiZ3JwYy5rZWVwYWxpdmVfdGltZW91dF9tc1wiOiAyNTAwMCBcblx0XHRcdFx0XCJncnBjLm1heF9yZWNlaXZlX21lc3NhZ2VfbGVuZ3RoXCI6IC0xXG5cdFx0XHR9XG5cdFx0KTtcblxuXHRcdHRoaXMuc3RyZWFtID0gdGhpcy5jcmVhdGVTdHJlYW0oKTtcblx0XHR0aGlzLmluaXRJbnRha2UodGhpcy5zdHJlYW0pO1xuXHRcdGNvbnN0IHJlY29ubmVjdCA9ICgpID0+IHtcblx0XHRcdGlmKHRoaXMucmVjb25uZWN0X2RwYykge1xuXHRcdFx0XHRjbGVhckRQQyh0aGlzLnJlY29ubmVjdF9kcGMpO1xuXHRcdFx0XHRkZWxldGUgdGhpcy5yZWNvbm5lY3RfZHBjO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmNsZWFyUGVuZGluZygpO1xuXHRcdFx0ZGVsZXRlIHRoaXMuc3RyZWFtO1xuXHRcdFx0ZGVsZXRlIHRoaXMuY2xpZW50O1xuXHRcdFx0aWYodGhpcy5yZWNvbm5lY3QpIHtcblx0XHRcdFx0dGhpcy5yZWNvbm5lY3RfZHBjID0gZHBjKDEwMDAsICgpID0+IHtcblx0XHRcdFx0XHR0aGlzLmNvbm5lY3QoKTtcblx0XHRcdFx0fSlcblx0XHRcdH1cblx0XHR9XG5cdFx0dGhpcy5zdHJlYW0ub24oJ2Vycm9yJywgKGVycm9yOmFueSkgPT4ge1xuXHRcdFx0dGhpcy52ZXJib3NlICYmIHRoaXMubG9nKCdzdHJlYW06ZXJyb3InLCBlcnJvcik7XG5cdFx0XHRyZWNvbm5lY3QoKTtcblx0XHR9KVxuXHRcdHRoaXMuc3RyZWFtLm9uKCdlbmQnLCAoKSA9PiB7XG5cdFx0XHRyZWNvbm5lY3QoKTtcblx0XHR9KVxuXHR9XG5cblx0ZGlzY29ubmVjdCgpIHtcblx0XHRpZih0aGlzLnJlY29ubmVjdF9kcGMpIHtcblx0XHRcdGNsZWFyRFBDKHRoaXMucmVjb25uZWN0X2RwYyk7XG5cdFx0XHRkZWxldGUgdGhpcy5yZWNvbm5lY3RfZHBjO1xuXHRcdH1cblx0XHR0aGlzLnJlY29ubmVjdCA9IGZhbHNlO1xuXHRcdHRoaXMuc3RyZWFtICYmIHRoaXMuc3RyZWFtLmVuZCgpO1xuXHRcdHRoaXMuY2xlYXJQZW5kaW5nKCk7XG5cdH1cblxuXHRjbGVhclBlbmRpbmcoKSB7XG5cdFx0T2JqZWN0LmtleXModGhpcy5wZW5kaW5nKS5mb3JFYWNoKGtleSA9PiB7XG5cdFx0XHRsZXQgbGlzdCA9IHRoaXMucGVuZGluZ1trZXldO1xuXHRcdFx0bGlzdC5mb3JFYWNoKG89Pm8ucmVqZWN0KCdjbG9zaW5nIGJ5IGZvcmNlJykpO1xuXHRcdFx0dGhpcy5wZW5kaW5nW2tleV0gPSBbXTtcblx0XHR9KTtcblx0fVxuXG5cdGNsb3NlKCkge1xuXHRcdHRoaXMuZGlzY29ubmVjdCgpXG5cdH1cblxuXHRjcmVhdGVTdHJlYW0oKSB7XG5cdFx0aWYoIXRoaXMuY2xpZW50KVxuXHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0Y29uc3Qgc3RyZWFtID0gdGhpcy5jbGllbnQuTWVzc2FnZVN0cmVhbSgoKT0+e1xuXHRcdH0pO1xuXHRcdHJldHVybiBzdHJlYW07XG5cdH1cblxuXHRpbml0SW50YWtlKHN0cmVhbTpJU3RyZWFtKSB7XG5cdFx0c3RyZWFtLm9uKCdkYXRhJywgKGRhdGE6YW55KSA9PiB7XG5cdFx0XHRpZihkYXRhLnBheWxvYWQpIHtcblx0XHRcdFx0bGV0IG5hbWUgPSBkYXRhLnBheWxvYWQ7XG5cdFx0XHRcdGxldCBwYXlsb2FkID0gZGF0YVtuYW1lXTtcblx0XHRcdFx0bGV0IGlkZW50ID0gbmFtZS5yZXBsYWNlKC9eZ2V0fFJlc3BvbnNlJC9pZywnJykudG9Mb3dlckNhc2UoKTtcblx0XHRcdFx0dGhpcy5oYW5kbGVJbnRha2Uoe25hbWUsIHBheWxvYWQsIGlkZW50IH0pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0aGFuZGxlSW50YWtlKG86SURhdGEpIHtcblx0XHRpZih0aGlzLmludGFrZUhhbmRsZXIpIHtcblx0XHRcdHRoaXMuaW50YWtlSGFuZGxlcihvKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bGV0IGhhbmRsZXJzID0gdGhpcy5wZW5kaW5nW28ubmFtZV07XG5cdFx0XHR0aGlzLnZlcmJvc2UgJiYgY29uc29sZS5sb2coJ2ludGFrZTonLG8sJ2hhbmRsZXJzOicsaGFuZGxlcnMpO1xuXHRcdFx0aWYoaGFuZGxlcnMgJiYgaGFuZGxlcnMubGVuZ3RoKXtcblx0XHRcdFx0bGV0IHBlbmRpbmc6UXVldWVJdGVtfHVuZGVmaW5lZCA9IGhhbmRsZXJzLnNoaWZ0KCk7XG5cdFx0XHRcdGlmKHBlbmRpbmcpXG5cdFx0XHRcdFx0cGVuZGluZy5yZXNvbHZlKG8ucGF5bG9hZCk7XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0c2V0SW50YWtlSGFuZGxlcihmbjpGdW5jdGlvbikge1xuXHRcdHRoaXMuaW50YWtlSGFuZGxlciA9IGZuO1xuXHR9XG5cblx0cG9zdChuYW1lOnN0cmluZywgYXJnczphbnk9eyB9KSB7XG5cdFx0aWYoIXRoaXMuc3RyZWFtKVxuXHRcdFx0cmV0dXJuIGZhbHNlO1xuXG5cdFx0bGV0IHJlcSA9IHtcblx0XHRcdFtuYW1lXTphcmdzXG5cdFx0fVxuXHRcdHRoaXMudmVyYm9zZSAmJiB0aGlzLmxvZygncG9zdDonLHJlcSk7XG5cdFx0dGhpcy5zdHJlYW0ud3JpdGUocmVxKTtcblxuXHRcdHJldHVybiB0cnVlO1xuXHR9XG5cblx0Y2FsbChtZXRob2Q6c3RyaW5nLCBkYXRhOmFueSkge1xuXHRcdHRoaXMudmVyYm9zZSAmJiB0aGlzLmxvZygnY2FsbCB0bycsIG1ldGhvZCk7XG5cdFx0aWYoIXRoaXMuY2xpZW50KVxuXHRcdFx0cmV0dXJuIFByb21pc2UucmVqZWN0KCdub3QgY29ubmVjdGVkJyk7XG5cblx0XHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdFx0bGV0IHN0cmVhbSA9IHRoaXMuc3RyZWFtO1xuXHRcdFx0aWYoIXN0cmVhbSkge1xuXHRcdFx0XHR0aGlzLnZlcmJvc2UgJiYgIHRoaXMubG9nKCdjb3VsZCBub3QgY3JlYXRlIHN0cmVhbScpO1xuXHRcdFx0XHRyZXR1cm4gcmVqZWN0KCdub3QgY29ubmVjdGVkJyk7XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IHJlc3AgPSBtZXRob2QucmVwbGFjZSgvUmVxdWVzdCQvLCdSZXNwb25zZScpO1xuXHRcdFx0aWYoIXRoaXMucGVuZGluZ1tyZXNwXSlcblx0XHRcdFx0dGhpcy5wZW5kaW5nW3Jlc3BdID0gW107XG5cdFx0XHRsZXQgaGFuZGxlcnM6UXVldWVJdGVtW10gPSB0aGlzLnBlbmRpbmdbcmVzcF07XG5cdFx0XHRoYW5kbGVycy5wdXNoKHttZXRob2QsIGRhdGEsIHJlc29sdmUsIHJlamVjdH0pO1xuXG5cdFx0XHR0aGlzLnBvc3QobWV0aG9kLCBkYXRhKTtcblx0XHR9KVxuXHR9XG5cbn1cbiJdfQ==