"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Client = void 0;
const flow_async_1 = require("@aspectron/flow-async");
const gRPC = require("@grpc/grpc-js");
const protoLoader = require("@grpc/proto-loader");
class Client {
    constructor(options) {
        this.reconnect = true;
        this.verbose = false;
        this.options = Object.assign({
            protoPath: __dirname + '/../../messages.proto',
            host: 'localhost:16210'
        }, options || {});
        this.pending = {};
        this.log = Function.prototype.bind.call(console.log, console, `[KASPA-RPC-CLIENT]:`);
    }
    getServiceClient() {
        const { protoPath } = this.options;
        const packageDefinition = protoLoader.loadSync(protoPath, {
            keepCase: true,
            longs: String,
            enums: String,
            defaults: true,
            oneofs: true
        });
        const proto = gRPC.loadPackageDefinition(packageDefinition);
        const { P2P, RPC } = proto.protowire;
        return RPC;
    }
    connect() {
        this.reconnect = true;
        this.log('gRPC Client connecting to', this.options.host);
        const RPC = this.getServiceClient();
        this.client = new RPC(this.options.host, gRPC.credentials.createInsecure(), {
        // "grpc.keepalive_timeout_ms": 25000 
        });
        this.stream = this.createStream();
        this.initIntake(this.stream);
        const reconnect = () => {
            if (this.reconnect_dpc) {
                flow_async_1.clearDPC(this.reconnect_dpc);
                delete this.reconnect_dpc;
            }
            this.clearPending();
            delete this.stream;
            delete this.client;
            if (this.reconnect) {
                this.reconnect_dpc = flow_async_1.dpc(1000, () => {
                    this.connect();
                });
            }
        };
        this.stream.on('error', (error) => {
            this.log('stream:error', error);
            reconnect();
        });
        this.stream.on('end', () => {
            reconnect();
        });
    }
    disconnect() {
        if (this.reconnect_dpc) {
            flow_async_1.clearDPC(this.reconnect_dpc);
            delete this.reconnect_dpc;
        }
        this.reconnect = false;
        this.stream && this.stream.end();
        this.clearPending();
    }
    clearPending() {
        Object.keys(this.pending).forEach(key => {
            let list = this.pending[key];
            list.forEach(o => o.reject('closing by force'));
            this.pending[key] = [];
        });
    }
    close() {
        this.disconnect();
    }
    createStream() {
        if (!this.client)
            return null;
        const stream = this.client.MessageStream(() => {
        });
        return stream;
    }
    initIntake(stream) {
        stream.on('data', (data) => {
            if (data.payload) {
                let name = data.payload;
                let payload = data[name];
                let ident = name.replace(/^get|Response$/ig, '').toLowerCase();
                this.handleIntake({ name, payload, ident });
            }
        });
    }
    handleIntake(o) {
        if (this.intakeHandler) {
            this.intakeHandler(o);
        }
        else {
            let handlers = this.pending[o.name];
            this.verbose && console.log('intake:', o, 'handlers:', handlers);
            if (handlers && handlers.length) {
                let pending = handlers.shift();
                if (pending)
                    pending.resolve(o.payload);
            }
        }
    }
    setIntakeHandler(fn) {
        this.intakeHandler = fn;
    }
    post(name, args = {}) {
        if (!this.stream)
            return false;
        let req = {
            [name]: args
        };
        this.verbose && this.log('post:', req);
        this.stream.write(req);
        return true;
    }
    call(method, data) {
        this.verbose && this.log('call to', method);
        if (!this.client)
            return Promise.reject('not connected');
        return new Promise((resolve, reject) => {
            let stream = this.stream;
            if (!stream) {
                this.log('could not create stream');
                return reject('not connected');
            }
            const resp = method.replace(/Request$/, 'Response');
            if (!this.pending[resp])
                this.pending[resp] = [];
            let handlers = this.pending[resp];
            handlers.push({ method, data, resolve, reject });
            this.post(method, data);
        });
    }
}
exports.Client = Client;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vbGliL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFHQSxzREFBc0Q7QUFDdEQsc0NBQXNDO0FBQ3RDLGtEQUFrRDtBQU9sRCxNQUFhLE1BQU07SUFXbEIsWUFBWSxPQUFXO1FBTnZCLGNBQVMsR0FBVyxJQUFJLENBQUM7UUFHekIsWUFBTyxHQUFXLEtBQUssQ0FBQztRQUl2QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDNUIsU0FBUyxFQUFFLFNBQVMsR0FBRyx1QkFBdUI7WUFDOUMsSUFBSSxFQUFFLGlCQUFpQjtTQUN2QixFQUFFLE9BQU8sSUFBRSxFQUFFLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUcsQ0FBQztRQUNuQixJQUFJLENBQUMsR0FBRyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDdEMsT0FBTyxDQUFDLEdBQUcsRUFDWCxPQUFPLEVBQ1AscUJBQXFCLENBQ3JCLENBQUM7SUFDSCxDQUFDO0lBRUQsZ0JBQWdCO1FBQ2YsTUFBTSxFQUFDLFNBQVMsRUFBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDakMsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtZQUN6RCxRQUFRLEVBQUUsSUFBSTtZQUNkLEtBQUssRUFBRSxNQUFNO1lBQ2IsS0FBSyxFQUFFLE1BQU07WUFDYixRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxJQUFJO1NBQ1osQ0FBQyxDQUFDO1FBRUgsTUFBTSxLQUFLLEdBQWdDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3pGLE1BQU0sRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUNuQyxPQUFPLEdBQUcsQ0FB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LENBQUM7WUFDekIsSUFBSSxRQUFRLEdBQWUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5QyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztZQUUvQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQTtJQUNILENBQUM7Q0FFRDtBQXpLRCx3QkF5S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGRwYywgY2xlYXJEUEMgfSBmcm9tICdAYXNwZWN0cm9uL2Zsb3ctYXN5bmMnO1xuaW1wb3J0ICogYXMgZ1JQQyBmcm9tICdAZ3JwYy9ncnBjLWpzJztcbmltcG9ydCAqIGFzIHByb3RvTG9hZGVyIGZyb20gJ0BncnBjL3Byb3RvLWxvYWRlcic7XG5pbXBvcnQge1xuXHRQZW5kaW5nUmVxcywgSURhdGEsIElTdHJlYW0sIFF1ZXVlSXRlbSwgTWVzc2FnZXNQcm90byxcblx0U2VydmljZUNsaWVudENvbnN0cnVjdG9yXG59IGZyb20gJy4uL3R5cGVzL2N1c3RvbS10eXBlcyc7XG5cblxuZXhwb3J0IGNsYXNzIENsaWVudCB7XG5cdHN0cmVhbTpJU3RyZWFtO1xuXHRvcHRpb25zOmFueTtcblx0cGVuZGluZzpQZW5kaW5nUmVxcztcblx0aW50YWtlSGFuZGxlcjpGdW5jdGlvbnx1bmRlZmluZWQ7XG5cdHJlY29ubmVjdDpib29sZWFuID0gdHJ1ZTtcblx0Y2xpZW50OmFueXx1bmRlZmluZWQ7XG5cdHJlY29ubmVjdF9kcGM6bnVtYmVyfHVuZGVmaW5lZDtcblx0dmVyYm9zZTpib29sZWFuID0gZmFsc2U7XG5cdGxvZzpGdW5jdGlvbjtcblxuXHRjb25zdHJ1Y3RvcihvcHRpb25zOmFueSkge1xuXHRcdHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuXHRcdFx0cHJvdG9QYXRoOiBfX2Rpcm5hbWUgKyAnLy4uLy4uL21lc3NhZ2VzLnByb3RvJyxcblx0XHRcdGhvc3Q6ICdsb2NhbGhvc3Q6MTYyMTAnXG5cdFx0fSwgb3B0aW9uc3x8e30pO1xuXHRcdHRoaXMucGVuZGluZyA9IHsgfTtcblx0XHR0aGlzLmxvZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoXG5cdFx0XHRjb25zb2xlLmxvZyxcblx0XHRcdGNvbnNvbGUsXG5cdFx0XHRgW0tBU1BBLVJQQy1DTElFTlRdOmBcblx0XHQpO1xuXHR9XG5cblx0Z2V0U2VydmljZUNsaWVudCgpOlNlcnZpY2VDbGllbnRDb25zdHJ1Y3RvciB7XG5cdFx0Y29uc3Qge3Byb3RvUGF0aH0gPSB0aGlzLm9wdGlvbnM7XG5cdFx0Y29uc3QgcGFja2FnZURlZmluaXRpb24gPSBwcm90b0xvYWRlci5sb2FkU3luYyhwcm90b1BhdGgsIHtcblx0XHRcdGtlZXBDYXNlOiB0cnVlLFxuXHRcdFx0bG9uZ3M6IFN0cmluZyxcblx0XHRcdGVudW1zOiBTdHJpbmcsXG5cdFx0XHRkZWZhdWx0czogdHJ1ZSxcblx0XHRcdG9uZW9mczogdHJ1ZVxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgcHJvdG86TWVzc2FnZXNQcm90byA9IDxNZXNzYWdlc1Byb3RvPmdSUEMubG9hZFBhY2thZ2VEZWZpbml0aW9uKHBhY2thZ2VEZWZpbml0aW9uKTtcblx0XHRjb25zdCB7UDJQLCBSUEN9ID0gcHJvdG8ucHJvdG93aXJlO1xuXHRcdHJldHVybiBSUEM7XG5cdH1cblxuXHRjb25uZWN0KCkge1xuXHRcdHRoaXMucmVjb25uZWN0ID0gdHJ1ZTtcblx0XHR0aGlzLmxvZygnZ1JQQyBDbGllbnQgY29ubmVjdGluZyB0bycsIHRoaXMub3B0aW9ucy5ob3N0KTtcblx0XHRjb25zdCBSUEMgPSB0aGlzLmdldFNlcnZpY2VDbGllbnQoKTtcblx0XHR0aGlzLmNsaWVudCA9IG5ldyBSUEModGhpcy5vcHRpb25zLmhvc3QsIGdSUEMuY3JlZGVudGlhbHMuY3JlYXRlSW5zZWN1cmUoKSxcblx0XHRcdHsgXG5cdFx0XHRcdC8vIFwiZ3JwYy5rZWVwYWxpdmVfdGltZW91dF9tc1wiOiAyNTAwMCBcblx0XHRcdH1cblx0XHQpO1xuXG5cdFx0dGhpcy5zdHJlYW0gPSB0aGlzLmNyZWF0ZVN0cmVhbSgpO1xuXHRcdHRoaXMuaW5pdEludGFrZSh0aGlzLnN0cmVhbSk7XG5cdFx0Y29uc3QgcmVjb25uZWN0ID0gKCkgPT4ge1xuXHRcdFx0aWYodGhpcy5yZWNvbm5lY3RfZHBjKSB7XG5cdFx0XHRcdGNsZWFyRFBDKHRoaXMucmVjb25uZWN0X2RwYyk7XG5cdFx0XHRcdGRlbGV0ZSB0aGlzLnJlY29ubmVjdF9kcGM7XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuY2xlYXJQZW5kaW5nKCk7XG5cdFx0XHRkZWxldGUgdGhpcy5zdHJlYW07XG5cdFx0XHRkZWxldGUgdGhpcy5jbGllbnQ7XG5cdFx0XHRpZih0aGlzLnJlY29ubmVjdCkge1xuXHRcdFx0XHR0aGlzLnJlY29ubmVjdF9kcGMgPSBkcGMoMTAwMCwgKCkgPT4ge1xuXHRcdFx0XHRcdHRoaXMuY29ubmVjdCgpO1xuXHRcdFx0XHR9KVxuXHRcdFx0fVxuXHRcdH1cblx0XHR0aGlzLnN0cmVhbS5vbignZXJyb3InLCAoZXJyb3I6YW55KSA9PiB7XG5cdFx0XHR0aGlzLmxvZygnc3RyZWFtOmVycm9yJywgZXJyb3IpO1xuXHRcdFx0cmVjb25uZWN0KCk7XG5cdFx0fSlcblx0XHR0aGlzLnN0cmVhbS5vbignZW5kJywgKCkgPT4ge1xuXHRcdFx0cmVjb25uZWN0KCk7XG5cdFx0fSlcblx0fVxuXG5cdGRpc2Nvbm5lY3QoKSB7XG5cdFx0aWYodGhpcy5yZWNvbm5lY3RfZHBjKSB7XG5cdFx0XHRjbGVhckRQQyh0aGlzLnJlY29ubmVjdF9kcGMpO1xuXHRcdFx0ZGVsZXRlIHRoaXMucmVjb25uZWN0X2RwYztcblx0XHR9XG5cdFx0dGhpcy5yZWNvbm5lY3QgPSBmYWxzZTtcblx0XHR0aGlzLnN0cmVhbSAmJiB0aGlzLnN0cmVhbS5lbmQoKTtcblx0XHR0aGlzLmNsZWFyUGVuZGluZygpO1xuXHR9XG5cblx0Y2xlYXJQZW5kaW5nKCkge1xuXHRcdE9iamVjdC5rZXlzKHRoaXMucGVuZGluZykuZm9yRWFjaChrZXkgPT4ge1xuXHRcdFx0bGV0IGxpc3QgPSB0aGlzLnBlbmRpbmdba2V5XTtcblx0XHRcdGxpc3QuZm9yRWFjaChvPT5vLnJlamVjdCgnY2xvc2luZyBieSBmb3JjZScpKTtcblx0XHRcdHRoaXMucGVuZGluZ1trZXldID0gW107XG5cdFx0fSk7XG5cdH1cblxuXHRjbG9zZSgpIHtcblx0XHR0aGlzLmRpc2Nvbm5lY3QoKVxuXHR9XG5cblx0Y3JlYXRlU3RyZWFtKCkge1xuXHRcdGlmKCF0aGlzLmNsaWVudClcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdGNvbnN0IHN0cmVhbSA9IHRoaXMuY2xpZW50Lk1lc3NhZ2VTdHJlYW0oKCk9Pntcblx0XHR9KTtcblx0XHRyZXR1cm4gc3RyZWFtO1xuXHR9XG5cblx0aW5pdEludGFrZShzdHJlYW06SVN0cmVhbSkge1xuXHRcdHN0cmVhbS5vbignZGF0YScsIChkYXRhOmFueSkgPT4ge1xuXHRcdFx0aWYoZGF0YS5wYXlsb2FkKSB7XG5cdFx0XHRcdGxldCBuYW1lID0gZGF0YS5wYXlsb2FkO1xuXHRcdFx0XHRsZXQgcGF5bG9hZCA9IGRhdGFbbmFtZV07XG5cdFx0XHRcdGxldCBpZGVudCA9IG5hbWUucmVwbGFjZSgvXmdldHxSZXNwb25zZSQvaWcsJycpLnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRcdHRoaXMuaGFuZGxlSW50YWtlKHtuYW1lLCBwYXlsb2FkLCBpZGVudCB9KTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGhhbmRsZUludGFrZShvOklEYXRhKSB7XG5cdFx0aWYodGhpcy5pbnRha2VIYW5kbGVyKSB7XG5cdFx0XHR0aGlzLmludGFrZUhhbmRsZXIobyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGxldCBoYW5kbGVycyA9IHRoaXMucGVuZGluZ1tvLm5hbWVdO1xuXHRcdFx0dGhpcy52ZXJib3NlICYmIGNvbnNvbGUubG9nKCdpbnRha2U6JyxvLCdoYW5kbGVyczonLGhhbmRsZXJzKTtcblx0XHRcdGlmKGhhbmRsZXJzICYmIGhhbmRsZXJzLmxlbmd0aCl7XG5cdFx0XHRcdGxldCBwZW5kaW5nOlF1ZXVlSXRlbXx1bmRlZmluZWQgPSBoYW5kbGVycy5zaGlmdCgpO1xuXHRcdFx0XHRpZihwZW5kaW5nKVxuXHRcdFx0XHRcdHBlbmRpbmcucmVzb2x2ZShvLnBheWxvYWQpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHNldEludGFrZUhhbmRsZXIoZm46RnVuY3Rpb24pIHtcblx0XHR0aGlzLmludGFrZUhhbmRsZXIgPSBmbjtcblx0fVxuXG5cdHBvc3QobmFtZTpzdHJpbmcsIGFyZ3M6YW55PXsgfSkge1xuXHRcdGlmKCF0aGlzLnN0cmVhbSlcblx0XHRcdHJldHVybiBmYWxzZTtcblxuXHRcdGxldCByZXEgPSB7XG5cdFx0XHRbbmFtZV06YXJnc1xuXHRcdH1cblx0XHR0aGlzLnZlcmJvc2UgJiYgdGhpcy5sb2coJ3Bvc3Q6JyxyZXEpO1xuXHRcdHRoaXMuc3RyZWFtLndyaXRlKHJlcSk7XG5cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdGNhbGwobWV0aG9kOnN0cmluZywgZGF0YTphbnkpIHtcblx0XHR0aGlzLnZlcmJvc2UgJiYgdGhpcy5sb2coJ2NhbGwgdG8nLCBtZXRob2QpO1xuXHRcdGlmKCF0aGlzLmNsaWVudClcblx0XHRcdHJldHVybiBQcm9taXNlLnJlamVjdCgnbm90IGNvbm5lY3RlZCcpO1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdGxldCBzdHJlYW0gPSB0aGlzLnN0cmVhbTtcblx0XHRcdGlmKCFzdHJlYW0pIHtcblx0XHRcdFx0dGhpcy5sb2coJ2NvdWxkIG5vdCBjcmVhdGUgc3RyZWFtJyk7XG5cdFx0XHRcdHJldHVybiByZWplY3QoJ25vdCBjb25uZWN0ZWQnKTtcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgcmVzcCA9IG1ldGhvZC5yZXBsYWNlKC9SZXF1ZXN0JC8sJ1Jlc3BvbnNlJyk7XG5cdFx0XHRpZighdGhpcy5wZW5kaW5nW3Jlc3BdKVxuXHRcdFx0XHR0aGlzLnBlbmRpbmdbcmVzcF0gPSBbXTtcblx0XHRcdGxldCBoYW5kbGVyczpRdWV1ZUl0ZW1bXSA9IHRoaXMucGVuZGluZ1tyZXNwXTtcblx0XHRcdGhhbmRsZXJzLnB1c2goe21ldGhvZCwgZGF0YSwgcmVzb2x2ZSwgcmVqZWN0fSk7XG5cblx0XHRcdHRoaXMucG9zdChtZXRob2QsIGRhdGEpO1xuXHRcdH0pXG5cdH1cblxufVxuIl19